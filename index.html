<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Fixed AR Summoning</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        #ui-layer {
            position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 10; pointer-events: none;
        }
        .btn-text {
            background: rgba(0, 0, 0, 0.6); color: #ffff00; padding: 10px 20px; border-radius: 20px;
            font-family: sans-serif; font-weight: bold; border: 2px solid #ffff00;
        }
    </style>
</head>
<body>
    <div id="ui-layer"><span class="btn-text">AR 버튼을 누르고 -> 화면을 터치하세요!</span></div>

    <a-scene 
        renderer="antialias: true; alpha: true"
        xr-mode-ui="enabled: true; enterAREnabled: true; XRMode: ar">

        <a-camera position="0 1.6 0">
            <a-entity 
                id="cursor-ring"
                position="0 0 -1" 
                geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                material="color: #00ff00; shader: flat; opacity: 0.8; transparent: true">
            </a-entity>
        </a-camera>

        <a-light type="directional" position="1 4 2" intensity="1"></a-light>
        <a-light type="ambient" intensity="0.5"></a-light>

    </a-scene>

    <script>
        // 나를 쳐다보는 컴포넌트
        AFRAME.registerComponent('look-at-camera', {
            tick: function () {
                if (!this.el.sceneEl.camera) return;
                this.el.object3D.lookAt(this.el.sceneEl.camera.el.object3D.position);
            }
        });

        const scene = document.querySelector('a-scene');
        const uiText = document.querySelector('.btn-text');

        // 소환 함수
        function spawnMagic() {
            // 1. 현재 카메라(내 눈)의 위치와 회전값 가져오기
            const cameraEl = document.querySelector('a-camera');
            const worldPos = new THREE.Vector3();
            const worldDir = new THREE.Vector3();

            // 카메라의 정확한 월드 좌표 추출
            cameraEl.object3D.getWorldPosition(worldPos);
            cameraEl.object3D.getWorldDirection(worldDir);
            
            // worldDir은 카메라가 보는 방향(보통 -z)을 가리킴. 
            // 내 눈앞 0.8미터 위치 계산: 현재위치 + (바라보는방향 * 거리)
            // 주의: Three.js에서 방향 벡터는 정규화되어 있음
            const spawnDistance = 0.8;
            const spawnPos = {
                x: worldPos.x + (worldDir.x * spawnDistance),
                y: worldPos.y + (worldDir.y * spawnDistance), // AR에서는 높이 보정 안 함 (보는 높이 그대로)
                z: worldPos.z + (worldDir.z * spawnDistance)
            };

            // --- 정령 생성 (이전과 동일) ---
            const wisp = document.createElement('a-entity');
            
            // 위치 적용
            wisp.setAttribute('position', spawnPos);
            wisp.setAttribute('look-at-camera', ''); // 나를 쳐다봄

            const color = '#' + Math.floor(Math.random()*16777215).toString(16);

            // 핵
            const core = document.createElement('a-sphere');
            core.setAttribute('radius', '0.08');
            core.setAttribute('material', `color: ${color}; shader: flat; opacity: 0.9; transparent: true`);
            core.setAttribute('animation', 'property: scale; from: 0.9 0.9 0.9; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 500');
            wisp.appendChild(core);

            // 고리
            const ring = document.createElement('a-torus');
            ring.setAttribute('radius', '0.2');
            ring.setAttribute('radius-tubular', '0.005');
            ring.setAttribute('material', `color: white; opacity: 0.6; transparent: true`);
            ring.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 2000; easing: linear');
            wisp.appendChild(ring);

            // 등장 효과
            wisp.setAttribute('scale', '0 0 0');
            wisp.setAttribute('animation__pop', 'property: scale; to: 1 1 1; dur: 400; easing: easeOutBack');

            scene.appendChild(wisp);
            
            uiText.innerText = "✨ 소환됨! (" + color + ")";
            uiText.style.color = color;
            uiText.style.borderColor = color;
        }

        // 터치 이벤트 연결
        // 모바일 터치 + PC 클릭 모두 대응
        window.addEventListener('touchstart', spawnMagic);
        window.addEventListener('click', spawnMagic);

    </script>
</body>
</html>

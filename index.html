<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR í¬ì¸íŠ¸ í—Œí„° (Prototype)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- three.js (3D/AR) - ES Module -->
    <!-- [ìˆ˜ì •] WebXRì´ ì°¨ë‹¨ë˜ì–´ three.js ë° ARButton ê´€ë ¨ importë¥¼ ì œê±°/ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
      }
    }
    </script>
    -->
    <!-- Application Structure Plan: ì´ ì•±ì€ 'ì§€ë„ íƒìƒ‰'ê³¼ 'AR ê²½í—˜'ì´ë¼ëŠ” ë‘ ê°€ì§€ í•µì‹¬ ìƒíƒœë¥¼ ê°–ìŠµë‹ˆë‹¤. 1) 'ì§€ë„ í™”ë©´(screen-map)'ì´ ê¸°ë³¸ì´ë©°, Leaflet.jsë¥¼ ì‚¬ìš©í•´ ì‚¬ìš©ìì™€ ê°€ë§¹ì  ìœ„ì¹˜ë¥¼ ì‹¤ì‹œê°„ í‘œì‹œí•©ë‹ˆë‹¤. 2) Geolocation APIë¡œ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ì—¬ 20m ì´ë‚´ì¼ ë•Œ 'AR ì‹œì‘' ë²„íŠ¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) 'AR ì‹œì‘' ë²„íŠ¼ í´ë¦­ ì‹œ, 'AR ì˜¤ë²„ë ˆì´(screen-ar-overlay)'ê°€ í™œì„±í™”ë˜ê³  WebXR ì„¸ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤. 4) three.jsê°€ AR ê³µê°„ì— 3D ê°ì²´ë¥¼ ë Œë”ë§í•˜ê³ , í„°ì¹˜(Raycaster)ë¡œ ê°ì²´ íšë“ ìƒí˜¸ì‘ìš©ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì´ êµ¬ì¡°ëŠ” GPS ê¸°ë°˜ íƒìƒ‰ê³¼ ëª°ì…í˜• AR ê²½í—˜ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•©ë‹ˆë‹¤. -->
    <!-- Visualization & Content Choices: ì§€ë„: ì •ë³´(ìœ„ì¹˜) -> ëª©í‘œ(íƒìƒ‰) -> Leaflet.js ë§µ -> ì‚¬ìš©ìê°€ ì‹¤ì œ ì„¸ê³„ì—ì„œ ê°€ë§¹ì ê³¼ì˜ ê±°ë¦¬/ë°©í–¥ì„ ì§ê´€ì ìœ¼ë¡œ ì¸ì§€ -> Leaflet.js + Geolocation API. | AR ì˜¤ë¸Œì íŠ¸: ì •ë³´(ë¦¬ì›Œë“œ) -> ëª©í‘œ(íšë“) -> 3D TorusKnot(ë„ë„›) -> ì‚¬ìš©ìê°€ ì¹´ë©”ë¼ ë·°ì—ì„œ ë¦¬ì›Œë“œë¥¼ ì‹œê°ì ìœ¼ë¡œ ë°œê²¬í•˜ê³  í„°ì¹˜ë¡œ íšë“ -> three.js + WebXR API. ì´ ë°©ì‹ë“¤ì€ ì‹¤ì œ APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°íšì•ˆì˜ í•µì‹¬ ê¸°ëŠ¥ì„ í”„ë¡œí† íƒ€ì…ìœ¼ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        /* ... existing style code ... */
        #modal-reward-content.active {
            transform: scale(1);
            opacity: 1;
        }
        .leaflet-control-attribution {
            display: none; /* ì§€ë„ ì €ì‘ê¶Œ í‘œì‹œ ìˆ¨ê¹€ (í…ŒìŠ¤íŠ¸ìš©) */
        }

        /* [ì¶”ê°€] ì‹œë®¬ë ˆì´ì…˜ AR ê°ì²´ë¥¼ ìœ„í•œ CSS (Mockupì—ì„œ ê°€ì ¸ì˜´) */
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px) scale(1.05);
            }
        }

        .ar-object {
            position: absolute;
            width: 72px;
            height: 72px;
            background-color: #1B64F2; /* Toss Blue */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: 800;
            border: 4px solid white;
            box-shadow: 0 10px 25px rgba(27, 100, 242, 0.5), 0 0 0 10px rgba(255, 255, 255, 0.1);
            cursor: pointer;
            animation: float 4s ease-in-out infinite;
            transition: all 0.3s ease;
            z-index: 40; /* ì˜¤ë²„ë ˆì´ UI ìš”ì†Œ */
        }

        .ar-object:hover {
            transform: scale(1.15) !important;
        }
    </style>
</head>
<body>
    <div id="app-container">

        <!-- Screen 1: Loading -->
        <div id="screen-loading" class="screen active items-center justify-center text-center p-8 bg-white">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">AR í¬ì¸íŠ¸ í—Œí„°</h1>
            <p class="text-gray-600">í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</p>
            <p class="text-gray-500 text-sm mt-4">ë¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>
        </div>

        <!-- Screen 2: Map View -->
        <div id="screen-map" class="screen">
            <div id="map"></div>
            <div id="info-panel" class="bg-white p-4 shadow-t-lg rounded-t-2xl">
                <div class="text-center">
                    <h2 class="text-xl font-bold">[A Gachon Cafe]</h2>
                    <p id="distance-info" class="text-lg text-gray-600 mt-1">ê³„ì‚° ì¤‘...</p>
                </div>
                <button id="btn-start-ar" class="w-full bg-blue-600 text-white font-bold text-lg py-4 px-6 rounded-xl mt-4 shadow-lg transition-all transform disabled:bg-gray-400 disabled:opacity-50" disabled>
                    ARë¡œ í¬ì¸íŠ¸ ì¡ê¸°
                </button>
            </div>
        </div>

        <!-- Screen 3: AR UI Overlay -->
        <div id="screen-ar-overlay" class="screen justify-between p-4 bg-slate-800"> <!-- [ìˆ˜ì •] ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´ ë°°ê²½ìƒ‰ ì¶”ê°€ -->
            <button id="btn-close-ar" class="bg-black bg-opacity-40 text-white w-12 h-12 rounded-full text-2xl font-bold leading-10 text-center z-50">
                X
            </button>
            
            <!-- [ì¶”ê°€] ì‹œë®¬ë ˆì´ì…˜ AR ê°ì²´ ì»¨í…Œì´ë„ˆ -->
            <div id="ar-object-container-simulated" class="absolute inset-0 w-full h-full z-30">
                <!-- ì‹œë®¬ë ˆì´ì…˜ ê°ì²´ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤. -->
            </div>

            <!-- AR íšë“ ëª¨ë‹¬ -->
            <div id="modal-reward" class="absolute inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
                <div id="modal-reward-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-sm text-center p-8 m-4 transform scale-0 opacity-0 transition-all duration-300">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">íšë“!</h2>
                    <p class="text-lg text-gray-700 mb-6">
                        <span id="reward-name" class="font-bold text-blue-600">1,000 í¬ì¸íŠ¸</span>ë¥¼ ì¡ì•˜ìŠµë‹ˆë‹¤!
                    </p>
                    <button id="btn-claim-reward" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Unsupported -->
        <div id="screen-unsupported" class="screen items-center justify-center text-center p-8 bg-white">
            <h1 class="text-2xl font-bold text-red-600 mb-4">ì˜¤ë¥˜</h1>
            <p class="text-gray-700">ì´ ê¸°ê¸° ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œëŠ” WebXR(AR)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <p class="text-gray-500 text-sm mt-4">ìµœì‹  ë²„ì „ì˜ Chrome ë˜ëŠ” Safarië¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
        </div>

    </div>

    <script type="module">
        // [ìˆ˜ì •] three.js import ì œê±°
        // import * as THREE from 'three';
        // import { ARButton } from 'three/addons/webxr/ARButton.js';

        const screens = {
            loading: document.getElementById('screen-loading'),
            map: document.getElementById('screen-map'),
            arOverlay: document.getElementById('screen-ar-overlay'),
            unsupported: document.getElementById('screen-unsupported')
        };
        
        const infoPanel = document.getElementById('distance-info');
        const arButton = document.getElementById('btn-start-ar');
        const closeArButton = document.getElementById('btn-close-ar');
        const modalReward = document.getElementById('modal-reward');
        const modalRewardContent = document.getElementById('modal-reward-content');
        const claimRewardButton = document.getElementById('btn-claim-reward');

        let map, userMarker, merchantMarker;
        let merchantLatLng = null; // [lat, lng]
        let userLatLng = null; // [lat, lng]
        const activationDistance = 20; // 20m ì´ë‚´

        // [ìˆ˜ì •] WebXR ê´€ë ¨ ë³€ìˆ˜ ì œê±°
        // let camera, scene, renderer, controller;
        // let arObject;
        // let xrSession = null;

        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenId]) screens[screenId].classList.add('active');
        }

        // --- Map Logic (Leaflet.js) ---

        function initMap(firstPos) {
            userLatLng = [firstPos.coords.latitude, firstPos.coords.longitude];
            
            // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‚¬ìš©ìì˜ ì²« ìœ„ì¹˜ì—ì„œ ë¶ìª½ìœ¼ë¡œ 50m ì§€ì ì— ê°€ë§¹ì  ìƒì„±
            merchantLatLng = calculateOffset(userLatLng[0], userLatLng[1], 50, 0); 

            map = L.map('map').setView(userLatLng, 18); // 18 zoom level

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            userMarker = L.circle(userLatLng, {
                color: '#1B64F2',
                fillColor: '#1B64F2',
                fillOpacity: 0.3,
                radius: 5 // 5m ë°˜ê²½
            }).addTo(map);
            
            merchantMarker = L.marker(merchantLatLng).addTo(map)
                .bindPopup('<b>A Gachon Cafe</b><br>AR í¬ì¸íŠ¸ íšë“ ê°€ëŠ¥!')
                .openPopup();

            showScreen('map');
            updateDistance();
            
            // navigator.geolocation.watchPosition(updateUserPosition, handleLocationError, { enableHighAccuracy: true });
            // [ìˆ˜ì •] Geolocation APIê°€ í”Œë«í¼ ì •ì±…ìœ¼ë¡œ ì°¨ë‹¨ë˜ì–´ watchPositionì„ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        }

        function updateUserPosition(pos) {
            // [ìˆ˜ì •] watchPositionì´ í˜¸ì¶œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ í•¨ìˆ˜ì˜ ë‚´ìš©ì€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            /*
            userLatLng = [pos.coords.latitude, pos.coords.longitude];
            userMarker.setLatLng(userLatLng);
            map.panTo(userLatLng); // ì‚¬ìš©ìë¥¼ ë”°ë¼ ì§€ë„ ì´ë™
            updateDistance();
            */
        }

        function updateDistance() {
            if (!userLatLng || !merchantLatLng) return;

            // const dist = haversineDistance(userLatLng, merchantLatLng);
            // infoPanel.textContent = `ê°€ë§¹ì ê¹Œì§€ ì•½ ${dist.toFixed(0)}m ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;

            // [ìˆ˜ì •] Geolocation APIê°€ ì°¨ë‹¨ë˜ì–´, í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê±°ë¦¬ë¥¼ ë¬´ì‹œí•˜ê³  í•­ìƒ í™œì„±í™”í•©ë‹ˆë‹¤.
            infoPanel.textContent = `ê°€ë§¹ì ê¹Œì§€ ì•½ 10m ë‚¨ì•˜ìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)`;

            // if (dist <= activationDistance) {
                arButton.disabled = false;
                arButton.textContent = 'ARë¡œ í¬ì¸íŠ¸ ì¡ê¸° (ì‹œë®¬ë ˆì´ì…˜)';
            // } else {
            //    arButton.disabled = true;
            //    arButton.textContent = 'ARë¡œ í¬ì¸íŠ¸ ì¡ê¸°';
            // }
        }

        function handleLocationError(error) {
            console.error("Geolocation Error:", error.message);
            infoPanel.textContent = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }

        // --- AR Logic (Three.js + WebXR) ---
        // [ìˆ˜ì •] WebXR ë¡œì§ì„ ì‹œë®¬ë ˆì´ì…˜ ë¡œì§ìœ¼ë¡œ ë³€ê²½

        async function initXR() {
            // [ìˆ˜ì •] WebXR ì§€ì› í™•ì¸ ë¡œì§ ì œê±°. ëŒ€ì‹  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë§Œ ì—°ê²°
            arButton.addEventListener('click', activateXR);
            closeArButton.addEventListener('click', endXR);
            claimRewardButton.addEventListener('click', hideModal);
        }

        async function activateXR() {
            // [ìˆ˜ì •] ì‹¤ì œ XR ì„¸ì…˜ ìš”ì²­ ëŒ€ì‹ , ì‹œë®¬ë ˆì´ì…˜ í™”ë©´ í‘œì‹œ
            showScreen('arOverlay');
            spawnSimulatedArObjects(5); // ì‹œë®¬ë ˆì´ì…˜ ê°ì²´ ìƒì„±
        }
        
        function endXR() {
            // [ìˆ˜ì •] XR ì„¸ì…˜ ì¢…ë£Œ ëŒ€ì‹ , ì‹œë®¬ë ˆì´ì…˜ í™”ë©´ ë‹«ê¸°
            showScreen('map');
            // ì‹œë®¬ë ˆì´ì…˜ ê°ì²´ ì •ë¦¬
            const container = document.getElementById('ar-object-container-simulated');
            if (container) container.innerHTML = '';
        }

        // [ì¶”ê°€] ì‹œë®¬ë ˆì´ì…˜ ê°ì²´ ìƒì„± í•¨ìˆ˜ (Mockupì—ì„œ ê°€ì ¸ì˜´)
        function spawnSimulatedArObjects(count) {
            const container = document.getElementById('ar-object-container-simulated');
            container.innerHTML = ''; 
            const rewards = [
                { name: '1,000 í¬ì¸íŠ¸', icon: 'P' },
                { name: '500ì› ì¿ í°', icon: 'C' },
                { name: '100 í¬ì¸íŠ¸', icon: 'P' },
                { name: '2,000 í¬ì¸íŠ¸', icon: 'P' },
                { name: 'ë¬´ë£Œ ì»¤í”¼ ì¿ í°', icon: 'C' }
            ];

            for (let i = 0; i < count; i++) {
                const reward = rewards[i % rewards.length];
                const arObject = document.createElement('div');
                arObject.className = 'ar-object';
                arObject.innerHTML = `<span>${reward.icon}</span>`;
                arObject.dataset.rewardName = reward.name;
                
                const x = Math.random() * 80 + 10; 
                const y = Math.random() * 70 + 15;
                
                arObject.style.left = `${x}%`;
                arObject.style.top = `${y}%`;
                // transform ì†ì„±ì€ @keyframesì—ì„œ ê´€ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì œì™¸
                arObject.style.animationDelay = `${Math.random() * -4}s`;

                arObject.addEventListener('click', (e) => {
                    captureObject(e.currentTarget); // ì‹œë®¬ë ˆì´ì…˜ ê°ì²´ ìº¡ì²˜
                });
                
                container.appendChild(arObject);
            }
        }
        
        // [ìˆ˜ì •] captureObjectê°€ DOM ìš”ì†Œë¥¼ ë°›ë„ë¡ ìˆ˜ì •
        function captureObject(element) {
            const rewardName = element.dataset.rewardName;
            document.getElementById('reward-name').textContent = rewardName;
            showModal();
            element.remove(); // ì¡ì•˜ìœ¼ë‹ˆ DOMì—ì„œ ì œê±°
        }

        function showModal() {
            modalReward.style.display = 'flex';
            setTimeout(() => {
                modalRewardContent.classList.add('active');
            }, 10);
        }
        
        function hideModal() {
            modalRewardContent.classList.remove('active');
            setTimeout(() => {
                modalReward.style.display = 'none';
                // [ìˆ˜ì •] ëª¨ë“  ì‹œë®¬ë ˆì´ì…˜ ê°ì²´ë¥¼ ì¡ì•˜ëŠ”ì§€ í™•ì¸
                const container = document.getElementById('ar-object-container-simulated');
                if (container && container.children.length === 0) {
                    endXR();
                }
            }, 300);
        }

        // [ì‚­ì œ] ë¶ˆí•„ìš”í•´ì§„ WebXR ê´€ë ¨ í•¨ìˆ˜ë“¤
        // function onSessionStarted(session) { ... }
        // function onSessionEnded() { ... }
        // function onXRFrame(time, frame) { ... }
        // function spawnArObject() { ... }
        // function onSelect(event) { ... }

        // --- Utility Functions ---

        function haversineDistance([lat1, lon1], [lat2, lon2]) {
            const R = 6371e3; // metres
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // in metres
        }
        
        function calculateOffset(lat, lon, distance, bearing) {
            const R = 6371e3; // metres
            const brng = bearing * Math.PI / 180; // Bearing is 0Â°(N), 90Â°(E), 180Â°(S), 270Â°(W)
            const d = distance;

            const lat1 = lat * Math.PI / 180;
            const lon1 = lon * Math.PI / 180;

            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(d / R) +
                         Math.cos(lat1) * Math.sin(d / R) * Math.cos(brng));

            const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(d / R) * Math.cos(lat1),
                                 Math.cos(d / R) - Math.sin(lat1) * Math.sin(lat2));

            return [lat2 * 180 / Math.PI, lon2 * 180 / Math.PI];
        }

        // --- App Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    initMap(pos); // ì§€ë„ ì´ˆê¸°í™”
                    initXR();     // AR ê¸°ëŠ¥ ì¤€ë¹„
                },
                (err) => {
                    console.error(err.message);
                    showScreen('loading');
                    screens.loading.innerHTML = '<p class="text-red-600 p-8">ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

    </script>
</body>
</html>



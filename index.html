<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LifeGo: AR Quest Layer 1</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        /* --- HUD (Head-Up Display) ìŠ¤íƒ€ì¼ --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #ar-ui {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* í•˜ë‹¨ ë°°ì¹˜ */
            padding: 20px;
            box-sizing: border-box;
        }

        /* í”Œë ˆì´ì–´ ìƒíƒœì°½ (ì¢Œì¸¡ í•˜ë‹¨) */
        .player-stats {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            padding: 15px;
            width: 250px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto; /* í„°ì¹˜ ê°€ëŠ¥í•˜ê²Œ */
        }

        .avatar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; border: 2px solid #fff; }
        .level-badge { font-size: 18px; font-weight: bold; color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .fire-icon { color: #ff9500; margin-left: 5px; }

        .xp-bar-container {
            width: 100%; height: 10px; background: rgba(255,255,255,0.3);
            border-radius: 5px; overflow: hidden; margin-top: 5px;
        }
        .xp-fill {
            height: 100%; background: #00e676; width: 45%;
            box-shadow: 0 0 10px #00e676;
            transition: width 0.3s ease;
        }
        .xp-text { font-size: 12px; margin-top: 2px; text-align: right; opacity: 0.8; }

        /* íŠ¸ë¡œí”¼ ì•„ì´ì½˜ (ì—…ì ) */
        .trophy-btn {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            margin-left: 10px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* ì‹œë®¬ë ˆì´ì…˜ìš© ë²„íŠ¼ (ì‹¤ì œ ì—°ë™ ì‹œ Vision AIê°€ ëŒ€ì²´) */
        #sim-controls {
            position: absolute;
            top: 20px; right: 20px;
            pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        .sim-btn {
            background: rgba(0, 0, 0, 0.7); color: #00e676; border: 1px solid #00e676;
            padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="ar-ui">
        <div id="sim-controls">
            <button class="sim-btn" onclick="triggerDetection('washing_dishes')">ğŸ“¸ [TEST] ì„¤ê±°ì§€ ê°ì§€</button>
            <button class="sim-btn" onclick="triggerDetection('vacuuming')">ğŸ“¸ [TEST] ì²­ì†Œê¸° ê°ì§€</button>
        </div>

        <div style="display: flex; align-items: flex-end;">
            <div class="player-stats">
                <div class="avatar-row">
                    <div class="avatar" style="background: url('https://cdn-icons-png.flaticon.com/512/4140/4140048.png') center/cover;"></div>
                    <div>
                        <span class="level-badge">Level <span id="lvl-num">46</span></span>
                        <span class="fire-icon">ğŸ”¥ 2</span>
                    </div>
                    <div class="trophy-btn">ğŸ†</div>
                </div>
                <div class="xp-bar-container">
                    <div class="xp-fill" id="xp-bar" style="width: 0%"></div>
                </div>
                <div class="xp-text"><span id="xp-cur">0</span> / <span id="xp-max">100</span> XP</div>
            </div>
        </div>
    </div>

    <a-scene 
        webxr="optionalFeatures: dom-overlay; overlayElement: #ar-ui"
        vr-mode-ui="enabled: true"
        ar-mode-ui="enabled: true"
        renderer="antialias: true; colorManagement: true;">

        <a-assets>
            <img id="icon-check" src="https://cdn-icons-png.flaticon.com/512/190/190411.png">
        </a-assets>

        <a-camera position="0 1.6 0" look-controls="enabled: false">
            <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable"></a-entity>
        </a-camera>

        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" intensity="0.5" position="-1 2 1"></a-light>

        <a-entity id="floating-text-container"></a-entity>

    </a-scene>

    <script>
        // --- ìƒíƒœ ê´€ë¦¬ ---
        let currentXP = 45;
        const maxXP = 100;
        let currentLevel = 46;

        // --- ì„¤ì •: í™œë™ë³„ ë³´ìƒ ë°ì´í„° ---
        const ACTIVITY_DB = {
            'washing_dishes': { label: 'Washing Dishes', xp: 4, color: '#4CC3D9' }, // ì„¤ê±°ì§€
            'vacuuming': { label: 'Vacuuming', xp: 2, color: '#EF2D5E' }            // ì²­ì†Œ
        };

        // --- í•µì‹¬ ê¸°ëŠ¥ 1: í”Œë¡œíŒ… í…ìŠ¤íŠ¸ ìƒì„± (3D UI) ---
        // í™”ë©´ ì¤‘ì•™(í˜¹ì€ AIê°€ ê°ì§€í•œ ì¢Œí‘œ)ì— í…ìŠ¤íŠ¸ì™€ XPë¥¼ ë„ì›ë‹ˆë‹¤.
        function spawnFloatingText(activityKey, position) {
            const data = ACTIVITY_DB[activityKey];
            const container = document.getElementById('floating-text-container');
            
            // 1. ê·¸ë£¹ ì—”í‹°í‹° ìƒì„± (í…ìŠ¤íŠ¸ + ë°°ê²½ ë“±)
            const entity = document.createElement('a-entity');
            
            // ìœ„ì¹˜ ì„¤ì • (ì¹´ë©”ë¼ ì• 1.5m ì§€ì  í˜¹ì€ ì§€ì • ì¢Œí‘œ)
            if (!position) {
                const camera = document.querySelector('a-camera');
                const p = camera.object3D.position;
                // ì¹´ë©”ë¼ê°€ ë³´ê³  ìˆëŠ” ë°©í–¥ ë²¡í„° ê³„ì‚° (ê°„ë‹¨íˆ ì• 2m)
                const direction = new THREE.Vector3(0, 0, -2); 
                direction.applyQuaternion(camera.object3D.quaternion);
                entity.setAttribute('position', {
                    x: p.x + direction.x, 
                    y: p.y + direction.y, 
                    z: p.z + direction.z
                });
            } else {
                entity.setAttribute('position', position);
            }

            // ë¹Œë³´ë”© (í•­ìƒ ì¹´ë©”ë¼ ë³´ê¸°)
            entity.setAttribute('look-at', '[camera]');

            // 2. í…ìŠ¤íŠ¸ ìš”ì†Œ (í™œë™ ì´ë¦„)
            const titleText = document.createElement('a-text');
            titleText.setAttribute('value', data.label);
            titleText.setAttribute('align', 'center');
            titleText.setAttribute('position', '0 0.1 0');
            titleText.setAttribute('scale', '1.2 1.2 1.2');
            titleText.setAttribute('font', 'mozillavr');
            titleText.setAttribute('color', '#ffffff');
            titleText.setAttribute('shader', 'msdf');
            
            // 3. XP ë±ƒì§€ (ë…¹ìƒ‰ ë°°ê²½ + í…ìŠ¤íŠ¸)
            const xpEntity = document.createElement('a-entity');
            xpEntity.setAttribute('position', '0.8 0.15 0'); // ì œëª© ì˜†ì— ë°°ì¹˜
            
            const xpBg = document.createElement('a-plane');
            xpBg.setAttribute('color', '#00e676');
            xpBg.setAttribute('width', '0.6');
            xpBg.setAttribute('height', '0.25');
            xpBg.setAttribute('opacity', '0.9');
            xpBg.setAttribute('material', 'shader: flat');
            xpBg.setAttribute('class', 'clickable'); // í´ë¦­í•´ì„œ ìˆ˜ë ¹ ê°€ëŠ¥í•˜ê²Œ?

            const xpText = document.createElement('a-text');
            xpText.setAttribute('value', `+${data.xp} XP`);
            xpText.setAttribute('align', 'center');
            xpText.setAttribute('z-offset', '0.01'); // ë°°ê²½ë³´ë‹¤ ì‚´ì§ ì•
            xpText.setAttribute('scale', '0.8 0.8 0.8');

            xpEntity.appendChild(xpBg);
            xpEntity.appendChild(xpText);
            
            entity.appendChild(titleText);
            entity.appendChild(xpEntity);
            container.appendChild(entity);

            // 4. ì• ë‹ˆë©”ì´ì…˜ (ìœ„ë¡œ ë– ì˜¤ë¥´ë©´ì„œ ì‚¬ë¼ì§)
            entity.setAttribute('animation__pos', {
                property: 'position',
                to: `${entity.getAttribute('position').x} ${entity.getAttribute('position').y + 0.5} ${entity.getAttribute('position').z}`,
                dur: 2000,
                easing: 'easeOutQuad'
            });
            
            // íˆ¬ëª…ë„ ì• ë‹ˆë©”ì´ì…˜ (ìì‹ë“¤ì—ê²Œ ì „íŒŒê°€ ì•ˆë˜ë¯€ë¡œ ê°„ë‹¨íˆ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì œê±°)
            setTimeout(() => {
                if(entity.parentNode) entity.parentNode.removeChild(entity);
            }, 2000);

            // 5. XP ì—…ë°ì´íŠ¸
            addXP(data.xp);
        }

        // --- í•µì‹¬ ê¸°ëŠ¥ 2: XP ë° ë ˆë²¨ ë¡œì§ ---
        function addXP(amount) {
            currentXP += amount;
            if (currentXP >= maxXP) {
                currentXP = currentXP - maxXP;
                currentLevel++;
                document.getElementById('lvl-num').innerText = currentLevel;
                // ë ˆë²¨ì—… íš¨ê³¼ ì¶”ê°€ ê°€ëŠ¥
            }
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('xp-cur').innerText = currentXP;
            document.getElementById('xp-max').innerText = maxXP;
            document.getElementById('xp-bar').style.width = `${(currentXP / maxXP) * 100}%`;
        }

        // --- ì—°ë™ í¬ì¸íŠ¸: ì™¸ë¶€ ì‹ í˜¸ ìˆ˜ì‹  ---
        // ì‹¤ì œë¡œëŠ” WebSocketì´ë‚˜ ì„œë²„ì—ì„œ 'ì„¤ê±°ì§€ ê°ì§€ë¨' ì‹ í˜¸ë¥¼ ë°›ìœ¼ë©´ ì´ í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
        function triggerDetection(activityType) {
            console.log(`[Vision AI] Activity Detected: ${activityType}`);
            spawnFloatingText(activityType);
        }

        // ì´ˆê¸°í™”
        updateHUD();

    </script>
</body>
</html>

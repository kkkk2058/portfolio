<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR 포인트 헌터 (Prototype)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- three.js (3D/AR) - ES Module -->
    <!-- [수정] WebXR이 차단되어 three.js 및 ARButton 관련 import를 제거/주석 처리합니다.
    <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
      }
    }
    </script>
    -->
    <!-- Application Structure Plan: 이 앱은 '지도 탐색'과 'AR 경험'이라는 두 가지 핵심 상태를 갖습니다. 1) '지도 화면(screen-map)'이 기본이며, Leaflet.js를 사용해 사용자와 가맹점 위치를 실시간 표시합니다. 2) Geolocation API로 거리를 계산하여 20m 이내일 때 'AR 시작' 버튼을 활성화합니다. 3) 'AR 시작' 버튼 클릭 시, 'AR 오버레이(screen-ar-overlay)'가 활성화되고 WebXR 세션이 시작됩니다. 4) three.js가 AR 공간에 3D 객체를 렌더링하고, 터치(Raycaster)로 객체 획득 상호작용을 처리합니다. 이 구조는 GPS 기반 탐색과 몰입형 AR 경험을 자연스럽게 연결합니다. -->
    <!-- Visualization & Content Choices: 지도: 정보(위치) -> 목표(탐색) -> Leaflet.js 맵 -> 사용자가 실제 세계에서 가맹점과의 거리/방향을 직관적으로 인지 -> Leaflet.js + Geolocation API. | AR 오브젝트: 정보(리워드) -> 목표(획득) -> 3D TorusKnot(도넛) -> 사용자가 카메라 뷰에서 리워드를 시각적으로 발견하고 터치로 획득 -> three.js + WebXR API. 이 방식들은 실제 API를 사용하여 기획안의 핵심 기능을 프로토타입으로 구현합니다. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        /* ... existing style code ... */
        #modal-reward-content.active {
            transform: scale(1);
            opacity: 1;
        }
        .leaflet-control-attribution {
            display: none; /* 지도 저작권 표시 숨김 (테스트용) */
        }

        /* [추가] 시뮬레이션 AR 객체를 위한 CSS (Mockup에서 가져옴) */
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px) scale(1.05);
            }
        }

        .ar-object {
            position: absolute;
            width: 72px;
            height: 72px;
            background-color: #1B64F2; /* Toss Blue */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: 800;
            border: 4px solid white;
            box-shadow: 0 10px 25px rgba(27, 100, 242, 0.5), 0 0 0 10px rgba(255, 255, 255, 0.1);
            cursor: pointer;
            animation: float 4s ease-in-out infinite;
            transition: all 0.3s ease;
            z-index: 40; /* 오버레이 UI 요소 */
        }

        .ar-object:hover {
            transform: scale(1.15) !important;
        }
    </style>
</head>
<body>
    <div id="app-container">

        <!-- Screen 1: Loading -->
        <div id="screen-loading" class="screen active items-center justify-center text-center p-8 bg-white">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">AR 포인트 헌터</h1>
            <p class="text-gray-600">현재 위치를 확인 중입니다...</p>
            <p class="text-gray-500 text-sm mt-4">브라우저의 위치 정보 접근을 허용해주세요.</p>
        </div>

        <!-- Screen 2: Map View -->
        <div id="screen-map" class="screen">
            <div id="map"></div>
            <div id="info-panel" class="bg-white p-4 shadow-t-lg rounded-t-2xl">
                <div class="text-center">
                    <h2 class="text-xl font-bold">[A Gachon Cafe]</h2>
                    <p id="distance-info" class="text-lg text-gray-600 mt-1">계산 중...</p>
                </div>
                <button id="btn-start-ar" class="w-full bg-blue-600 text-white font-bold text-lg py-4 px-6 rounded-xl mt-4 shadow-lg transition-all transform disabled:bg-gray-400 disabled:opacity-50" disabled>
                    AR로 포인트 잡기
                </button>
            </div>
        </div>

        <!-- Screen 3: AR UI Overlay -->
        <div id="screen-ar-overlay" class="screen justify-between p-4 bg-slate-800"> <!-- [수정] 시뮬레이션을 위해 배경색 추가 -->
            <button id="btn-close-ar" class="bg-black bg-opacity-40 text-white w-12 h-12 rounded-full text-2xl font-bold leading-10 text-center z-50">
                X
            </button>
            
            <!-- [추가] 시뮬레이션 AR 객체 컨테이너 -->
            <div id="ar-object-container-simulated" class="absolute inset-0 w-full h-full z-30">
                <!-- 시뮬레이션 객체들이 여기에 생성됩니다. -->
            </div>

            <!-- AR 획득 모달 -->
            <div id="modal-reward" class="absolute inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
                <div id="modal-reward-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-sm text-center p-8 m-4 transform scale-0 opacity-0 transition-all duration-300">
                    <div class="text-6xl mb-4">🎉</div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">획득!</h2>
                    <p class="text-lg text-gray-700 mb-6">
                        <span id="reward-name" class="font-bold text-blue-600">1,000 포인트</span>를 잡았습니다!
                    </p>
                    <button id="btn-claim-reward" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg">
                        확인
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Unsupported -->
        <div id="screen-unsupported" class="screen items-center justify-center text-center p-8 bg-white">
            <h1 class="text-2xl font-bold text-red-600 mb-4">오류</h1>
            <p class="text-gray-700">이 기기 또는 브라우저에서는 WebXR(AR)을 지원하지 않습니다.</p>
            <p class="text-gray-500 text-sm mt-4">최신 버전의 Chrome 또는 Safari를 사용해주세요.</p>
        </div>

    </div>

    <script type="module">
        // [수정] three.js import 제거
        // import * as THREE from 'three';
        // import { ARButton } from 'three/addons/webxr/ARButton.js';

        const screens = {
            loading: document.getElementById('screen-loading'),
            map: document.getElementById('screen-map'),
            arOverlay: document.getElementById('screen-ar-overlay'),
            unsupported: document.getElementById('screen-unsupported')
        };
        
        const infoPanel = document.getElementById('distance-info');
        const arButton = document.getElementById('btn-start-ar');
        const closeArButton = document.getElementById('btn-close-ar');
        const modalReward = document.getElementById('modal-reward');
        const modalRewardContent = document.getElementById('modal-reward-content');
        const claimRewardButton = document.getElementById('btn-claim-reward');

        let map, userMarker, merchantMarker;
        let merchantLatLng = null; // [lat, lng]
        let userLatLng = null; // [lat, lng]
        const activationDistance = 20; // 20m 이내

        // [수정] WebXR 관련 변수 제거
        // let camera, scene, renderer, controller;
        // let arObject;
        // let xrSession = null;

        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenId]) screens[screenId].classList.add('active');
        }

        // --- Map Logic (Leaflet.js) ---

        function initMap(firstPos) {
            userLatLng = [firstPos.coords.latitude, firstPos.coords.longitude];
            
            // 테스트를 위해 사용자의 첫 위치에서 북쪽으로 50m 지점에 가맹점 생성
            merchantLatLng = calculateOffset(userLatLng[0], userLatLng[1], 50, 0); 

            map = L.map('map').setView(userLatLng, 18); // 18 zoom level

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            userMarker = L.circle(userLatLng, {
                color: '#1B64F2',
                fillColor: '#1B64F2',
                fillOpacity: 0.3,
                radius: 5 // 5m 반경
            }).addTo(map);
            
            merchantMarker = L.marker(merchantLatLng).addTo(map)
                .bindPopup('<b>A Gachon Cafe</b><br>AR 포인트 획득 가능!')
                .openPopup();

            showScreen('map');
            updateDistance();
            
            // navigator.geolocation.watchPosition(updateUserPosition, handleLocationError, { enableHighAccuracy: true });
            // [수정] Geolocation API가 플랫폼 정책으로 차단되어 watchPosition을 주석 처리합니다.
        }

        function updateUserPosition(pos) {
            // [수정] watchPosition이 호출되지 않으므로 이 함수의 내용은 실행되지 않습니다.
            /*
            userLatLng = [pos.coords.latitude, pos.coords.longitude];
            userMarker.setLatLng(userLatLng);
            map.panTo(userLatLng); // 사용자를 따라 지도 이동
            updateDistance();
            */
        }

        function updateDistance() {
            if (!userLatLng || !merchantLatLng) return;

            // const dist = haversineDistance(userLatLng, merchantLatLng);
            // infoPanel.textContent = `가맹점까지 약 ${dist.toFixed(0)}m 남았습니다.`;

            // [수정] Geolocation API가 차단되어, 테스트를 위해 거리를 무시하고 항상 활성화합니다.
            infoPanel.textContent = `가맹점까지 약 10m 남았습니다. (시뮬레이션)`;

            // if (dist <= activationDistance) {
                arButton.disabled = false;
                arButton.textContent = 'AR로 포인트 잡기 (시뮬레이션)';
            // } else {
            //    arButton.disabled = true;
            //    arButton.textContent = 'AR로 포인트 잡기';
            // }
        }

        function handleLocationError(error) {
            console.error("Geolocation Error:", error.message);
            infoPanel.textContent = "위치 정보를 가져올 수 없습니다.";
        }

        // --- AR Logic (Three.js + WebXR) ---
        // [수정] WebXR 로직을 시뮬레이션 로직으로 변경

        async function initXR() {
            // [수정] WebXR 지원 확인 로직 제거. 대신 이벤트 리스너만 연결
            arButton.addEventListener('click', activateXR);
            closeArButton.addEventListener('click', endXR);
            claimRewardButton.addEventListener('click', hideModal);
        }

        async function activateXR() {
            // [수정] 실제 XR 세션 요청 대신, 시뮬레이션 화면 표시
            showScreen('arOverlay');
            spawnSimulatedArObjects(5); // 시뮬레이션 객체 생성
        }
        
        function endXR() {
            // [수정] XR 세션 종료 대신, 시뮬레이션 화면 닫기
            showScreen('map');
            // 시뮬레이션 객체 정리
            const container = document.getElementById('ar-object-container-simulated');
            if (container) container.innerHTML = '';
        }

        // [추가] 시뮬레이션 객체 생성 함수 (Mockup에서 가져옴)
        function spawnSimulatedArObjects(count) {
            const container = document.getElementById('ar-object-container-simulated');
            container.innerHTML = ''; 
            const rewards = [
                { name: '1,000 포인트', icon: 'P' },
                { name: '500원 쿠폰', icon: 'C' },
                { name: '100 포인트', icon: 'P' },
                { name: '2,000 포인트', icon: 'P' },
                { name: '무료 커피 쿠폰', icon: 'C' }
            ];

            for (let i = 0; i < count; i++) {
                const reward = rewards[i % rewards.length];
                const arObject = document.createElement('div');
                arObject.className = 'ar-object';
                arObject.innerHTML = `<span>${reward.icon}</span>`;
                arObject.dataset.rewardName = reward.name;
                
                const x = Math.random() * 80 + 10; 
                const y = Math.random() * 70 + 15;
                
                arObject.style.left = `${x}%`;
                arObject.style.top = `${y}%`;
                // transform 속성은 @keyframes에서 관리하므로 여기서 제외
                arObject.style.animationDelay = `${Math.random() * -4}s`;

                arObject.addEventListener('click', (e) => {
                    captureObject(e.currentTarget); // 시뮬레이션 객체 캡처
                });
                
                container.appendChild(arObject);
            }
        }
        
        // [수정] captureObject가 DOM 요소를 받도록 수정
        function captureObject(element) {
            const rewardName = element.dataset.rewardName;
            document.getElementById('reward-name').textContent = rewardName;
            showModal();
            element.remove(); // 잡았으니 DOM에서 제거
        }

        function showModal() {
            modalReward.style.display = 'flex';
            setTimeout(() => {
                modalRewardContent.classList.add('active');
            }, 10);
        }
        
        function hideModal() {
            modalRewardContent.classList.remove('active');
            setTimeout(() => {
                modalReward.style.display = 'none';
                // [수정] 모든 시뮬레이션 객체를 잡았는지 확인
                const container = document.getElementById('ar-object-container-simulated');
                if (container && container.children.length === 0) {
                    endXR();
                }
            }, 300);
        }

        // [삭제] 불필요해진 WebXR 관련 함수들
        // function onSessionStarted(session) { ... }
        // function onSessionEnded() { ... }
        // function onXRFrame(time, frame) { ... }
        // function spawnArObject() { ... }
        // function onSelect(event) { ... }

        // --- Utility Functions ---

        function haversineDistance([lat1, lon1], [lat2, lon2]) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // in metres
        }
        
        function calculateOffset(lat, lon, distance, bearing) {
            const R = 6371e3; // metres
            const brng = bearing * Math.PI / 180; // Bearing is 0°(N), 90°(E), 180°(S), 270°(W)
            const d = distance;

            const lat1 = lat * Math.PI / 180;
            const lon1 = lon * Math.PI / 180;

            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(d / R) +
                         Math.cos(lat1) * Math.sin(d / R) * Math.cos(brng));

            const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(d / R) * Math.cos(lat1),
                                 Math.cos(d / R) - Math.sin(lat1) * Math.sin(lat2));

            return [lat2 * 180 / Math.PI, lon2 * 180 / Math.PI];
        }

        // --- App Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    initMap(pos); // 지도 초기화
                    initXR();     // AR 기능 준비
                },
                (err) => {
                    console.error(err.message);
                    showScreen('loading');
                    screens.loading.innerHTML = '<p class="text-red-600 p-8">위치 정보 권한이 필요합니다. 페이지를 새로고침하고 권한을 허용해주세요.</p>';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

    </script>
</body>
</html>



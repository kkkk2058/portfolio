<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LifeGo AR Quest System</title>
    
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        /* --- 2D HUD ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ë””ìì¸ ìœ ì§€) --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #ar-ui {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* UI ë°°ê²½ì€ í´ë¦­ í†µê³¼ (3D ì”¬ ì¡°ì‘ ê°€ëŠ¥) */
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* í•˜ë‹¨ ë°°ì¹˜ */
            padding: 20px;
            box-sizing: border-box;
        }

        /* í”Œë ˆì´ì–´ ìƒíƒœì°½ (ì¢Œì¸¡ í•˜ë‹¨) */
        .player-stats {
            background: rgba(0, 0, 0, 0.6); /* ë°˜íˆ¬ëª… ê²€ì • ë°°ê²½ */
            backdrop-filter: blur(5px);
            border-radius: 15px;
            padding: 15px;
            width: 280px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto; /* ë²„íŠ¼ ë“±ì€ í´ë¦­ ê°€ëŠ¥í•´ì•¼ í•¨ */
            margin-bottom: 20px; /* AR ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ */
        }

        .avatar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #ddd url('https://cdn-icons-png.flaticon.com/512/4140/4140048.png') center/cover; border: 2px solid #fff; }
        .level-info { display: flex; flex-direction: column; }
        .level-badge { font-size: 20px; font-weight: bold; color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .streak-badge { font-size: 14px; color: #ff9500; font-weight: bold; }

        /* ê²½í—˜ì¹˜ ë°” */
        .xp-bar-container {
            width: 100%; height: 10px; background: rgba(255,255,255,0.2);
            border-radius: 5px; overflow: hidden; margin-top: 5px;
        }
        .xp-fill {
            height: 100%; background: linear-gradient(90deg, #00e676, #00c853);
            width: 0%; /* JSë¡œ ì œì–´ */
            box-shadow: 0 0 10px #00e676;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .xp-text { font-size: 12px; margin-top: 4px; text-align: right; opacity: 0.9; font-weight: bold; }

        /* ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ (í…ŒìŠ¤íŠ¸ìš©) */
        #sim-controls {
            position: absolute;
            top: 20px; right: 20px;
            pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        .sim-btn {
            background: rgba(0, 230, 118, 0.2); color: #00e676; 
            border: 1px solid #00e676;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;
            backdrop-filter: blur(2px);
            transition: all 0.2s;
        }
        .sim-btn:active { background: rgba(0, 230, 118, 0.5); transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="ar-ui">
        <div id="sim-controls">
            <button class="sim-btn" onclick="triggerDetection('washing_dishes')">ğŸ“¸ ì„¤ê±°ì§€ ê°ì§€ (TEST)</button>
            <button class="sim-btn" onclick="triggerDetection('vacuuming')">ğŸ§¹ ì²­ì†Œ ê°ì§€ (TEST)</button>
        </div>

        <div style="width: 100%;">
            <div class="player-stats">
                <div class="avatar-row">
                    <div class="avatar"></div>
                    <div class="level-info">
                        <span class="level-badge">Lv. <span id="lvl-num">46</span></span>
                        <span class="streak-badge">ğŸ”¥ 2 Day Streak</span>
                    </div>
                </div>
                <div class="xp-bar-container">
                    <div class="xp-fill" id="xp-bar" style="width: 45%"></div>
                </div>
                <div class="xp-text"><span id="xp-cur">0</span> / <span id="xp-max">100</span> XP</div>
            </div>
        </div>
    </div>

    <a-scene 
        webxr="optionalFeatures: dom-overlay; overlayElement: #ar-ui; requiredFeatures: hit-test;"
        vr-mode-ui="enabled: false"
        ar-mode-ui="enabled: true; enterAREnabled: true;"
        renderer="alpha: true; antialias: true; colorManagement: true;">

        <a-camera position="0 1.6 0" look-controls="enabled: false"></a-camera>

        <a-light type="ambient" intensity="0.7"></a-light>
        <a-light type="directional" intensity="0.8" position="-1 2 1"></a-light>

        <a-entity id="floating-text-container"></a-entity>

    </a-scene>

    <script>
        // --- [Logic] ê²Œì„ ë°ì´í„° ë° ìƒíƒœ ê´€ë¦¬ ---
        let currentXP = 45;
        const maxXP = 100;
        let currentLevel = 46;

        // í™œë™ë³„ ë³´ìƒ ë°ì´í„° (DB ì—­í• )
        const ACTIVITY_DB = {
            'washing_dishes': { label: 'Washing Dishes', xp: 20, color: '#4CC3D9' },
            'vacuuming': { label: 'Vacuuming', xp: 15, color: '#EF2D5E' }
        };

        // --- [Logic] í”Œë¡œíŒ… í…ìŠ¤íŠ¸ ìƒì„± (3D World UI) ---
        function spawnFloatingText(activityKey) {
            const data = ACTIVITY_DB[activityKey];
            const container = document.getElementById('floating-text-container');
            const camera = document.querySelector('a-camera');

            // 1. 3D ê·¸ë£¹ ì—”í‹°í‹° ìƒì„±
            const entity = document.createElement('a-entity');
            
            // ìœ„ì¹˜ ê³„ì‚°: ì¹´ë©”ë¼ê°€ ë°”ë¼ë³´ëŠ” ë°©í–¥ ì• 1.5m ì§€ì 
            const p = camera.object3D.position;
            const direction = new THREE.Vector3(0, 0, -1.5); // 1.5ë¯¸í„° ì•
            direction.applyQuaternion(camera.object3D.quaternion);
            
            entity.setAttribute('position', {
                x: p.x + direction.x, 
                y: p.y + direction.y, 
                z: p.z + direction.z
            });

            // â˜… í•µì‹¬: í•­ìƒ ì¹´ë©”ë¼ë¥¼ ì •ë©´ìœ¼ë¡œ ë°”ë¼ë³´ê²Œ í•¨ (ê°€ë…ì„± í™•ë³´)
            entity.setAttribute('look-at', '[camera]');

            // 2. í…ìŠ¤íŠ¸ ìš”ì†Œ (í™œë™ ì´ë¦„)
            const titleText = document.createElement('a-text');
            titleText.setAttribute('value', data.label);
            titleText.setAttribute('align', 'center');
            titleText.setAttribute('position', '0 0.15 0');
            titleText.setAttribute('scale', '1.5 1.5 1.5');
            titleText.setAttribute('color', '#ffffff');
            titleText.setAttribute('shader', 'msdf');
            titleText.setAttribute('font', 'https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json');

            // 3. XP ë±ƒì§€ (ë‘¥ë‘¥ ëœ¨ëŠ” ê²½í—˜ì¹˜)
            const xpEntity = document.createElement('a-entity');
            xpEntity.setAttribute('position', '0.9 0.15 0'); // ì œëª© ì˜¤ë¥¸ìª½ì— ë°°ì¹˜

            const xpBg = document.createElement('a-plane');
            xpBg.setAttribute('color', '#00e676');
            xpBg.setAttribute('width', '0.7');
            xpBg.setAttribute('height', '0.3');
            xpBg.setAttribute('opacity', '0.9');
            xpBg.setAttribute('material', 'shader: flat');

            const xpText = document.createElement('a-text');
            xpText.setAttribute('value', `+${data.xp} XP`);
            xpText.setAttribute('align', 'center');
            xpText.setAttribute('z-offset', '0.01'); // ë°°ê²½ë³´ë‹¤ ì‚´ì§ ì•
            xpText.setAttribute('scale', '1 1 1');
            xpText.setAttribute('color', '#000'); // ë°ì€ ë°°ê²½ì—” ê²€ì€ ê¸€ì”¨

            xpEntity.appendChild(xpBg);
            xpEntity.appendChild(xpText);
            
            entity.appendChild(titleText);
            entity.appendChild(xpEntity);
            container.appendChild(entity);

            // 4. ì• ë‹ˆë©”ì´ì…˜: ìœ„ë¡œ ë– ì˜¤ë¥´ë©´ì„œ ì‚¬ë¼ì§ (Floating Effect)
            entity.setAttribute('animation__pos', {
                property: 'position',
                to: `${entity.getAttribute('position').x} ${entity.getAttribute('position').y + 0.8} ${entity.getAttribute('position').z}`,
                dur: 2500,
                easing: 'easeOutQuad'
            });
            
            // ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ (Scale 0ìœ¼ë¡œ ì¤„ì–´ë“¦)
            entity.setAttribute('animation__scale', {
                property: 'scale',
                to: '0 0 0',
                delay: 2000,
                dur: 500,
                easing: 'easeInQuad'
            });

            // ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ìœ„í•´ DOMì—ì„œ ì œê±°
            setTimeout(() => {
                if(entity.parentNode) entity.parentNode.removeChild(entity);
            }, 2600);

            // 5. ì‹¤ì œ ë°ì´í„° ë°˜ì˜
            addXP(data.xp);
        }

        // --- [Logic] XP ë° ë ˆë²¨ì—… ì‹œìŠ¤í…œ ---
        function addXP(amount) {
            currentXP += amount;
            if (currentXP >= maxXP) {
                currentXP = currentXP - maxXP;
                currentLevel++;
                
                // ë ˆë²¨ì—… íš¨ê³¼ (í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ ë“±)
                const lvlNum = document.getElementById('lvl-num');
                lvlNum.innerText = currentLevel;
                lvlNum.style.color = '#ffeb3b';
                setTimeout(() => lvlNum.style.color = 'white', 1000);
            }
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('xp-cur').innerText = currentXP;
            document.getElementById('xp-max').innerText = maxXP;
            const percentage = Math.min((currentXP / maxXP) * 100, 100);
            document.getElementById('xp-bar').style.width = `${percentage}%`;
        }

        // --- [Signal] ì™¸ë¶€ ì—°ë™ í¬ì¸íŠ¸ ---
        function triggerDetection(activityType) {
            console.log(`[Vision AI] Detected: ${activityType}`);
            spawnFloatingText(activityType);
        }

        // ì´ˆê¸° UI ë Œë”ë§
        updateHUD();

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR í¬ì¸íŠ¸ í—Œí„° (Prototype)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- three.js (3D/AR) - ES Module -->
    <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
      }
    }
    </script>

    <!-- Chosen Palette: Toss-Inspired Blue & Map UI -->
    <!-- Application Structure Plan: ì´ ì•±ì€ 'ì§€ë„ íƒìƒ‰'ê³¼ 'AR ê²½í—˜'ì´ë¼ëŠ” ë‘ ê°€ì§€ í•µì‹¬ ìƒíƒœë¥¼ ê°–ìŠµë‹ˆë‹¤. 1) 'ì§€ë„ í™”ë©´(screen-map)'ì´ ê¸°ë³¸ì´ë©°, Leaflet.jsë¥¼ ì‚¬ìš©í•´ ì‚¬ìš©ìì™€ ê°€ë§¹ì  ìœ„ì¹˜ë¥¼ ì‹¤ì‹œê°„ í‘œì‹œí•©ë‹ˆë‹¤. 2) Geolocation APIë¡œ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ì—¬ 20m ì´ë‚´ì¼ ë•Œ 'AR ì‹œì‘' ë²„íŠ¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤. 3) 'AR ì‹œì‘' ë²„íŠ¼ í´ë¦­ ì‹œ, 'AR ì˜¤ë²„ë ˆì´(screen-ar-overlay)'ê°€ í™œì„±í™”ë˜ê³  WebXR ì„¸ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤. 4) three.jsê°€ AR ê³µê°„ì— 3D ê°ì²´ë¥¼ ë Œë”ë§í•˜ê³ , í„°ì¹˜(Raycaster)ë¡œ ê°ì²´ íšë“ ìƒí˜¸ì‘ìš©ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì´ êµ¬ì¡°ëŠ” GPS ê¸°ë°˜ íƒìƒ‰ê³¼ ëª°ì…í˜• AR ê²½í—˜ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•©ë‹ˆë‹¤. -->
    <!-- Visualization & Content Choices: ì§€ë„: ì •ë³´(ìœ„ì¹˜) -> ëª©í‘œ(íƒìƒ‰) -> Leaflet.js ë§µ -> ì‚¬ìš©ìê°€ ì‹¤ì œ ì„¸ê³„ì—ì„œ ê°€ë§¹ì ê³¼ì˜ ê±°ë¦¬/ë°©í–¥ì„ ì§ê´€ì ìœ¼ë¡œ ì¸ì§€ -> Leaflet.js + Geolocation API. | AR ì˜¤ë¸Œì íŠ¸: ì •ë³´(ë¦¬ì›Œë“œ) -> ëª©í‘œ(íšë“) -> 3D TorusKnot(ë„ë„›) -> ì‚¬ìš©ìê°€ ì¹´ë©”ë¼ ë·°ì—ì„œ ë¦¬ì›Œë“œë¥¼ ì‹œê°ì ìœ¼ë¡œ ë°œê²¬í•˜ê³  í„°ì¹˜ë¡œ íšë“ -> three.js + WebXR API. ì´ ë°©ì‹ë“¤ì€ ì‹¤ì œ APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°íšì•ˆì˜ í•µì‹¬ ê¸°ëŠ¥ì„ í”„ë¡œí† íƒ€ì…ìœ¼ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        body, html {
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #f0f0f0;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        .screen.active {
            display: flex;
        }
        #map {
            width: 100%;
            flex-grow: 1; /* ì§€ë„ê°€ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
            z-index: 10;
        }
        #info-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }
        /* AR ìº”ë²„ìŠ¤ëŠ” three.jsê°€ ìë™ìœ¼ë¡œ ì „ì²´ í™”ë©´ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤ */
        #screen-ar-overlay {
            z-index: 30;
            pointer-events: none; /* AR ì”¬ í„°ì¹˜ë¥¼ ë°©í•´í•˜ì§€ ì•Šë„ë¡ */
        }
        #screen-ar-overlay > * {
            pointer-events: auto; /* ë²„íŠ¼ ë“± UI ìš”ì†ŒëŠ” í„°ì¹˜ ê°€ëŠ¥í•˜ë„ë¡ */
        }
        #modal-reward-content.active {
            transform: scale(1);
            opacity: 1;
        }
        .leaflet-control-attribution {
            display: none; /* ì§€ë„ ì €ì‘ê¶Œ í‘œì‹œ ìˆ¨ê¹€ (í…ŒìŠ¤íŠ¸ìš©) */
        }
    </style>
</head>
<body>
    <div id="app-container">

        <!-- Screen 1: Loading -->
        <div id="screen-loading" class="screen active items-center justify-center text-center p-8 bg-white">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">AR í¬ì¸íŠ¸ í—Œí„°</h1>
            <p class="text-gray-600">í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</p>
            <p class="text-gray-500 text-sm mt-4">ë¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>
        </div>

        <!-- Screen 2: Map View -->
        <div id="screen-map" class="screen">
            <div id="map"></div>
            <div id="info-panel" class="bg-white p-4 shadow-t-lg rounded-t-2xl">
                <div class="text-center">
                    <h2 class="text-xl font-bold">[A Gachon Cafe]</h2>
                    <p id="distance-info" class="text-lg text-gray-600 mt-1">ê³„ì‚° ì¤‘...</p>
                </div>
                <button id="btn-start-ar" class="w-full bg-blue-600 text-white font-bold text-lg py-4 px-6 rounded-xl mt-4 shadow-lg transition-all transform disabled:bg-gray-400 disabled:opacity-50" disabled>
                    ARë¡œ í¬ì¸íŠ¸ ì¡ê¸°
                </button>
            </div>
        </div>

        <!-- Screen 3: AR UI Overlay -->
        <div id="screen-ar-overlay" class="screen justify-between p-4">
            <button id="btn-close-ar" class="bg-black bg-opacity-40 text-white w-12 h-12 rounded-full text-2xl font-bold leading-10 text-center">
                X
            </button>
            
            <!-- AR íšë“ ëª¨ë‹¬ -->
            <div id="modal-reward" class="absolute inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
                <div id="modal-reward-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-sm text-center p-8 m-4 transform scale-0 opacity-0 transition-all duration-300">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">íšë“!</h2>
                    <p class="text-lg text-gray-700 mb-6">
                        <span id="reward-name" class="font-bold text-blue-600">1,000 í¬ì¸íŠ¸</span>ë¥¼ ì¡ì•˜ìŠµë‹ˆë‹¤!
                    </p>
                    <button id="btn-claim-reward" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Unsupported -->
        <div id="screen-unsupported" class="screen items-center justify-center text-center p-8 bg-white">
            <h1 class="text-2xl font-bold text-red-600 mb-4">ì˜¤ë¥˜</h1>
            <p class="text-gray-700">ì´ ê¸°ê¸° ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œëŠ” WebXR(AR)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <p class="text-gray-500 text-sm mt-4">ìµœì‹  ë²„ì „ì˜ Chrome ë˜ëŠ” Safarië¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
        </div>

    </div>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        const screens = {
            loading: document.getElementById('screen-loading'),
            map: document.getElementById('screen-map'),
            arOverlay: document.getElementById('screen-ar-overlay'),
            unsupported: document.getElementById('screen-unsupported')
        };
        
        const infoPanel = document.getElementById('distance-info');
        const arButton = document.getElementById('btn-start-ar');
        const closeArButton = document.getElementById('btn-close-ar');
        const modalReward = document.getElementById('modal-reward');
        const modalRewardContent = document.getElementById('modal-reward-content');
        const claimRewardButton = document.getElementById('btn-claim-reward');

        let map, userMarker, merchantMarker;
        let merchantLatLng = null; // [lat, lng]
        let userLatLng = null; // [lat, lng]
        const activationDistance = 20; // 20m ì´ë‚´

        let camera, scene, renderer, controller;
        let arObject;
        let xrSession = null;

        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenId]) screens[screenId].classList.add('active');
        }

        // --- Map Logic (Leaflet.js) ---

        function initMap(firstPos) {
            userLatLng = [firstPos.coords.latitude, firstPos.coords.longitude];
            
            // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‚¬ìš©ìì˜ ì²« ìœ„ì¹˜ì—ì„œ ë¶ìª½ìœ¼ë¡œ 50m ì§€ì ì— ê°€ë§¹ì  ìƒì„±
            merchantLatLng = calculateOffset(userLatLng[0], userLatLng[1], 50, 0); 

            map = L.map('map').setView(userLatLng, 18); // 18 zoom level

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            userMarker = L.circle(userLatLng, {
                color: '#1B64F2',
                fillColor: '#1B64F2',
                fillOpacity: 0.3,
                radius: 5 // 5m ë°˜ê²½
            }).addTo(map);
            
            merchantMarker = L.marker(merchantLatLng).addTo(map)
                .bindPopup('<b>A Gachon Cafe</b><br>AR í¬ì¸íŠ¸ íšë“ ê°€ëŠ¥!')
                .openPopup();

            showScreen('map');
            updateDistance();
            
            // Geolocation APIë¡œ ì‚¬ìš©ìì˜ ìœ„ì¹˜ë¥¼ ì‹¤ì‹œê°„ ì¶”ì í•©ë‹ˆë‹¤.
            navigator.geolocation.watchPosition(updateUserPosition, handleLocationError, { enableHighAccuracy: true });
        }

        function updateUserPosition(pos) {
            userLatLng = [pos.coords.latitude, pos.coords.longitude];
            userMarker.setLatLng(userLatLng);
            map.panTo(userLatLng); // ì‚¬ìš©ìë¥¼ ë”°ë¼ ì§€ë„ ì´ë™
            updateDistance();
        }

        function updateDistance() {
            if (!userLatLng || !merchantLatLng) return;

            const dist = haversineDistance(userLatLng, merchantLatLng);
            infoPanel.textContent = `ê°€ë§¹ì ê¹Œì§€ ì•½ ${dist.toFixed(0)}m ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;

            if (dist <= activationDistance) {
                arButton.disabled = false;
                arButton.textContent = 'ARë¡œ í¬ì¸íŠ¸ ì¡ê¸° (í™œì„±í™”!)';
            } else {
                arButton.disabled = true;
                arButton.textContent = 'ARë¡œ í¬ì¸íŠ¸ ì¡ê¸°';
            }
        }

        function handleLocationError(error) {
            console.error("Geolocation Error:", error.message);
            infoPanel.textContent = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }

        // --- AR Logic (Three.js + WebXR) ---

        async function initXR() {
            // 'xr' APIê°€ ë¸Œë¼ìš°ì €ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            if (!('xr' in navigator)) {
                showScreen('unsupported');
                return;
            }
            
            // 'immersive-ar' (AR) ì„¸ì…˜ì„ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
            if (!isSupported) {
                showScreen('unsupported');
                return;
            }

            // WebGL ë Œë”ëŸ¬ ì„¤ì •
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            // AR ìº”ë²„ìŠ¤ë¥¼ bodyì— ì¶”ê°€ (ì‹¤ì œ AR ì„¸ì…˜ì´ ì‹œì‘ë˜ë©´ ì´ ìº”ë²„ìŠ¤ê°€ íŒ¨ìŠ¤ìŠ¤ë£¨ë¥¼ ë‹´ë‹¹)
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0';
            renderer.domElement.style.left = '0';
            renderer.domElement.style.zIndex = '25';
            document.body.appendChild(renderer.domElement);

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // AR í™˜ê²½ì— ë¹› ì¶”ê°€
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);
            
            // ì»¨íŠ¸ë¡¤ëŸ¬ (í„°ì¹˜ ê°ì§€ìš©)
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect); // 'select'ëŠ” í™”ë©´ í„°ì¹˜ì— í•´ë‹¹
            scene.add(controller);

            // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            arButton.addEventListener('click', activateXR);
            closeArButton.addEventListener('click', endXR);
            claimRewardButton.addEventListener('click', hideModal);
        }

        async function activateXR() {
            try {
                // AR ì„¸ì…˜ì„ ìš”ì²­í•©ë‹ˆë‹¤ (ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œ ìš”ì²­ ë°œìƒ)
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'] // í‰ë©´ ì¸ì‹ì„ ì‚¬ìš©í•˜ë©´ ì¢‹ì§€ë§Œ, ì—†ì–´ë„ ë¨
                });
                onSessionStarted(xrSession);
            } catch (e) {
                console.error("AR ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨:", e);
                showScreen('unsupported');
            }
        }
        
        function onSessionStarted(session) {
            showScreen('arOverlay'); // UI ì˜¤ë²„ë ˆì´ í‘œì‹œ
            session.addEventListener('end', onSessionEnded);
            renderer.xr.setReferenceSpaceType('local');
            renderer.xr.setSession(session);
            renderer.setAnimationLoop(onXRFrame); // ë Œë”ë§ ë£¨í”„ ì‹œì‘
            spawnArObject(); // AR ê°ì²´ ìƒì„±
        }

        function onSessionEnded() {
            xrSession = null;
            renderer.setAnimationLoop(null);
            showScreen('map'); // ì§€ë„ í™”ë©´ìœ¼ë¡œ ë³µê·€
            // AR ê°ì²´ ì •ë¦¬
            if (arObject) {
                scene.remove(arObject);
                arObject = null;
            }
        }
        
        function endXR() {
            // ì‚¬ìš©ìê°€ X ë²„íŠ¼ì„ ëˆŒëŸ¬ AR ì„¸ì…˜ ì¢…ë£Œ
            if (xrSession) {
                xrSession.end();
            }
        }

        function onXRFrame(time, frame) {
            // ë§¤ í”„ë ˆì„ë§ˆë‹¤ AR ì¹´ë©”ë¼ ìœ„ì¹˜/ë°©í–¥ ì—…ë°ì´íŠ¸
            const referenceSpace = renderer.xr.getReferenceSpace();
            const session = renderer.xr.getSession();
            
            if (!referenceSpace) return;
            
            const pose = frame.getViewerPose(referenceSpace);
            if (pose) {
                camera.matrix.fromArray(pose.transform.matrix);
                camera.matrix.decompose(camera.position, camera.quaternion, camera.scale);
                camera.updateMatrixWorld(true);
            }
            
            // AR ê°ì²´ ì• ë‹ˆë©”ì´ì…˜ (ì œìë¦¬ì—ì„œ ë¹™ê¸€ë¹™ê¸€)
            if (arObject) {
                arObject.rotation.y += 0.01;
                arObject.rotation.x += 0.005;
            }

            // ì”¬ ë Œë”ë§
            renderer.render(scene, camera);
        }

        function spawnArObject() {
            // 3D í¬ì¸íŠ¸ ê°ì²´ ìƒì„± (íŒŒë€ìƒ‰ ë„ë„›)
            const geometry = new THREE.TorusKnotGeometry(0.2, 0.05, 100, 16);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x1B64F2, 
                shininess: 100 
            });
            arObject = new THREE.Mesh(geometry, material);
            
            // ì¹´ë©”ë¼ ì• 2m, ì•½ê°„ ì•„ë˜ì— ë°°ì¹˜
            arObject.position.set(0, -0.2, -2);
            arObject.userData.rewardName = '1,000 í¬ì¸íŠ¸'; // ê°ì²´ì— ë¦¬ì›Œë“œ ì •ë³´ ì €ì¥
            scene.add(arObject);
        }
        
        function onSelect(event) {
            // í™”ë©´ í„°ì¹˜ ì‹œ ì‹¤í–‰
            if (!arObject) return; // ì¡ì„ ê°ì²´ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ

            const raycaster = new THREE.Raycaster();
            const tempMatrix = new THREE.Matrix4();
            
            // í„°ì¹˜í•œ ìœ„ì¹˜ë¡œ Raycaster ì„¤ì •
            tempMatrix.identity().extractRotation(controller.matrixWorld);
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);
            
            // Raycasterê°€ AR ê°ì²´ì™€ ì¶©ëŒí•˜ëŠ”ì§€ í™•ì¸
            const intersects = raycaster.intersectObject(arObject);

            if (intersects.length > 0) {
                // ì¶©ëŒí–ˆë‹¤ë©´ ê°ì²´ íšë“
                captureObject(intersects[0].object);
            }
        }
        
        function captureObject(object) {
            // ëª¨ë‹¬ì— ë¦¬ì›Œë“œ ì´ë¦„ í‘œì‹œ
            document.getElementById('reward-name').textContent = object.userData.rewardName;
            showModal();
            scene.remove(object); // ì”¬ì—ì„œ ê°ì²´ ì œê±°
            arObject = null; // ì¡ì•˜ìœ¼ë‹ˆ null ì²˜ë¦¬
        }

        function showModal() {
            modalReward.style.display = 'flex';
            setTimeout(() => {
                modalRewardContent.classList.add('active');
            }, 10);
        }
        
        function hideModal() {
            modalRewardContent.classList.remove('active');
            setTimeout(() => {
                modalReward.style.display = 'none';
                // ëª¨ë“  ê°ì²´ë¥¼ ì¡ì•˜ìœ¼ë©´ (ì§€ê¸ˆì€ 1ê°œ) AR ì¢…ë£Œ
                if (!arObject) {
                    endXR();
                }
            }, 300);
        }


        // --- Utility Functions ---

        // ë‘ GPS ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ë¥¼ ë¯¸í„°(m) ë‹¨ìœ„ë¡œ ê³„ì‚° (Haversine ê³µì‹)
        function haversineDistance([lat1, lon1], [lat2, lon2]) {
            const R = 6371e3; // metres
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // in metres
        }
        
        // ê¸°ì¤€ ì¢Œí‘œì—ì„œ íŠ¹ì • ê±°ë¦¬(m)ì™€ ë°©ìœ„ê°(degree)ë§Œí¼ ë–¨ì–´ì§„ ìƒˆ ì¢Œí‘œ ê³„ì‚°
        function calculateOffset(lat, lon, distance, bearing) {
            const R = 6371e3; // metres
            const brng = bearing * Math.PI / 180; // Bearing is 0Â°(N), 90Â°(E), 180Â°(S), 270Â°(W)
            const d = distance;

            const lat1 = lat * Math.PI / 180;
            const lon1 = lon * Math.PI / 180;

            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(d / R) +
                         Math.cos(lat1) * Math.sin(d / R) * Math.cos(brng));

            const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(d / R) * Math.cos(lat1),
                                 Math.cos(d / R) - Math.sin(lat1) * Math.sin(lat2));

            return [lat2 * 180 / Math.PI, lon2 * 180 / Math.PI];
        }

        // --- App Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // (1) ë¨¼ì € ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤. (GPS ê¶Œí•œ ìš”ì²­ ë°œìƒ)
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    // (2) ìœ„ì¹˜ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì˜¤ë©´ ì§€ë„ ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
                    initMap(pos);
                    // (3) ë™ì‹œì— AR ê¸°ëŠ¥(three.js)ì„ ì¤€ë¹„ì‹œí‚µë‹ˆë‹¤.
                    initXR();
                },
                (err) => {
                    // ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì´ ê±°ë¶€ë˜ê±°ë‚˜ ì‹¤íŒ¨í–ˆì„ ë•Œ
                    console.error(err.message);
                    showScreen('loading');
                    screens.loading.innerHTML = '<p class="text-red-600 p-8">ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>';
                },
                // Geolocation ì˜µì…˜: ì •í™•ë„ ë†’ê²Œ, íƒ€ì„ì•„ì›ƒ 10ì´ˆ
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

    </script>
</body>
</html>

